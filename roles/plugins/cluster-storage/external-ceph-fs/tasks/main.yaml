- block:
    - name: FS Provisioner | Create storage-plugin directory
      file:
        path: "{{ kube_config_dir }}/plugins/storage-plugin/fs-provisioner"
        state: directory
        owner: root
        group: root
        mode: 0755
      when: inventory_hostname == groups['kube-master'][0]

    - name: FS Provisioner | Templates list
      set_fact:
        fs_provisioner_templates:
          - { file: 'ceph-fs-provisioner.yaml' }

    - name: FS Provisioner | Create manifests
      template:
        src: "{{ item.file }}.j2"
        dest: '{{ kube_config_dir }}/plugins/storage-plugin/fs-provisioner/{{ item.file }}'
      with_items: "{{ fs_provisioner_templates }}"
      when: inventory_hostname == groups['kube-master'][0]

    - name: FS Provisioner | Deploy manifests
      shell: "{{ bin_dir }}/kubectl apply -f {{ kube_config_dir }}/plugins/storage-plugin/fs-provisioner/{{ item.file }}"
      with_items: "{{ fs_provisioner_templates }}"
      when: inventory_hostname == groups['kube-master'][0]
  when: architectures == 'amd64'